---
import type { TervetuloaProcessed } from "@/utils/fetchindex";
import fs from 'fs/promises';
import path from 'path';

// Component props
const data: TervetuloaProcessed | null = Astro.props.data;

// Config
const MAX_INLINE_SVG_SIZE = 10 *1024; // 10 KB

// Utility to safely detect SVG
function isSvgFile(content: string): boolean {
  const cleaned = content.trimStart();
  return cleaned.startsWith('<svg');
}

// Get logo path
import fetchLogoImage from "@/utils/fetchlogo";
const logoPath = await fetchLogoImage(); // e.g. "/background/logo.svg"
const filePath = path.resolve('./public', logoPath);

let imageSrc: string;

try {
  const fileBuffer = await fs.readFile(filePath);
  const fileContent = fileBuffer.toString('utf8');

  const isSvg = isSvgFile(fileContent);
  const isSmallEnough = fileBuffer.length <= MAX_INLINE_SVG_SIZE;

  if (isSvg && isSmallEnough) {
    // Encode and inline SVG
    const encodedSvg = encodeURIComponent(fileContent)
      .replace(/'/g, '%27')
      .replace(/"/g, '%22');

    imageSrc = `data:image/svg+xml;utf8,${encodedSvg}`;
  } else {
    // Use as external file (too big or not SVG)
    imageSrc = logoPath;
  }
} catch (err) {
  console.error('❌ Failed to read logo file:', err);
  imageSrc = logoPath; // fallback just in case
}
---

{data ? (
  <div class="w-full max-w-5xl mx-auto bg-white/70 backdrop-blur-md rounded-3xl shadow-xl border border-green-200 px-8 py-12 space-y-6 text-center">
    <div class="flex justify-center items-center">
      <img 
        src={imageSrc}  
        alt="logo" 
        width="200" 
        height="150" 
        loading="eager"
        class="w-full max-w-[220px] sm:max-w-[260px] md:max-w-[300px] h-auto object-contain p-2 bg-amber-50 border border-white rounded-xl shadow-md"
      />
    </div>

    <h1 class="text-4xl sm:text-5xl font-extrabold text-green-800">
      {data.otsikko}
    </h1>

    <div 
      class="w-full text-center text-lg sm:text-xl text-gray-600 leading-relaxed space-y-2" 
      set:html={data.kuvaus} 
    />
  </div>
) : (
  <p class="text-lg text-gray-500">Lataa...</p>
)}
