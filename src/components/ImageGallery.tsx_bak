import React, { useEffect, useState } from 'react';
import ImageGallery from 'react-image-gallery';
import 'react-image-gallery/styles/css/image-gallery.css';

export interface ImageData {
  original: string;  // base path without extension
  thumbnail: string; // base path without extension
  description: string;
}

interface Props {
  data: ImageData[];
}

function loadImage(src: string): Promise<void> {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve();
      img.onerror = () => reject();
      img.src = src;
    });
  }
  
  export async function detectSupportedFormat(): Promise<"avif" | "webp" | "jpg"> {
    const avifSrc =
        "data:image/avif;base64,AAAAHGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZgAAAOptZXRhAAAAAAAAACFoZGxyAAAAAAAAAABwaWN0AAAAAAAAAAAAAAAAAAAAAA5waXRtAAAAAAABAAAAImlsb2MAAAAAREAAAQABAAAAAAEOAAEAAAAAAAAAIgAAACNpaW5mAAAAAAABAAAAFWluZmUCAAAAAAEAAGF2MDEAAAAAamlwcnAAAABLaXBjbwAAABNjb2xybmNseAABAA0AAIAAAAAMYXYxQ4EgAgAAAAAUaXNwZQAAAAAAAAAQAAAAEAAAABBwaXhpAAAAAAMICAgAAAAXaXBtYQAAAAAAAAABAAEEgYIDhAAAACptZGF0EgAKCDgM/9lAQ0AIMhQQAAAAFLm4wN/TRReKCcSo648oag==";
    const webpSrc =
      "data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoIAAgAAkA4JaQAA3AA/vuUAAA=";
  
    try {
      await loadImage(avifSrc);
      return "avif";
    } catch {
      try {
        await loadImage(webpSrc);
        return "webp";
      } catch {
        return "jpg";
      }
    }
  }
  export default function Gallery({ data }: Props) {
    const [extension, setExtension] = useState<"avif" | "webp" | "jpg">("jpg");
  
    useEffect(() => {
      detectSupportedFormat().then(setExtension);
    }, []);
  
    const galleryItems = data.map((img) => ({
      original: `${img.original}.${extension}`,
      thumbnail: `${img.thumbnail}.${extension}`,
      description: img.description,
    }));
  
    return (
      <div className="w-full flex justify-center mt-8 px-4">
        <div className="max-w-2xl w-full">
          <ImageGallery
            items={galleryItems}
            showPlayButton={false}
            showFullscreenButton={true}
          />
        </div>
      </div>
    );
  }
  